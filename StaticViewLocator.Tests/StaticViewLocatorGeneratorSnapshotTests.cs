using System.Threading.Tasks;
using StaticViewLocator.Tests.TestHelpers;
using Xunit;

namespace StaticViewLocator.Tests;

public class StaticViewLocatorGeneratorSnapshotTests
{
    [Fact]
    public async Task GeneratesAttributeAndLocatorSources()
    {
        const string input = @"
using Avalonia.Controls;
using StaticViewLocator;

namespace TestApp.ViewModels
{
    public abstract class ViewModelBase
    {
    }

    public class MainWindowViewModel : ViewModelBase
    {
    }

    public class TestViewModel : ViewModelBase
    {
    }

    public abstract class IgnoredViewModel : ViewModelBase
    {
    }
}

namespace TestApp.Views
{
    public class TestView : UserControl
    {
    }
}

namespace TestApp
{
    [StaticViewLocator]
    public partial class ViewLocator
    {
    }
}
";

        const string expectedAttribute = "// <auto-generated />\nusing System;\n\nnamespace StaticViewLocator;\n\n[AttributeUsage(AttributeTargets.Class, Inherited = false, AllowMultiple = false)]\npublic sealed class StaticViewLocatorAttribute : Attribute\n{\n}\n";

        const string expectedLocator = "// <auto-generated />\n#nullable enable\nusing System;\nusing System.Collections.Generic;\nusing Avalonia.Controls;\n\nnamespace TestApp;\n\npublic partial class ViewLocator\n{\n\tprivate static Dictionary<Type, Func<Control>> s_views = new()\n\t{\n\t\t[typeof(TestApp.ViewModels.MainWindowViewModel)] = () => new TextBlock() { Text = \"Not Found: TestApp.Views.MainWindowView\" },\n\t\t[typeof(TestApp.ViewModels.TestViewModel)] = () => new TestApp.Views.TestView(),\n\t};\n}\n";

        await StaticViewLocatorGeneratorVerifier.VerifyGeneratedSourcesAsync(
            input,
            ("StaticViewLocatorAttribute.cs", expectedAttribute),
            ("ViewLocator_StaticViewLocator.cs", expectedLocator));
    }
}
